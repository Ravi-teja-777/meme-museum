{% extends "base.html" %}

{% block title %}Meme Detail - Meme Museum{% endblock %}

{% block extra_styles %}
<style>
    .detail-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 2rem;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 2rem;
    }

    .meme-main {
        background: var(--white);
        padding: 2rem;
        border-radius: 20px;
        box-shadow: var(--shadow-lg);
    }

    .meme-image-container {
        text-align: center;
        margin-bottom: 2rem;
    }

    .meme-image-large {
        max-width: 100%;
        max-height: 600px;
        border-radius: 15px;
        box-shadow: var(--shadow);
    }

    .meme-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
    }

    .action-btn {
        flex: 1;
        min-width: 120px;
        padding: 0.8rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .btn-like {
        background: #FF6B6B;
        color: white;
    }

    .btn-like:hover {
        background: #EE5A52;
        transform: scale(1.05);
    }

    .btn-download {
        background: var(--secondary);
        color: white;
    }

    .btn-download:hover {
        background: #00A67E;
    }

    .btn-delete {
        background: #D63031;
        color: white;
    }

    .btn-delete:hover {
        background: #C0232A;
    }

    .meme-sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .info-card {
        background: var(--white);
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: var(--shadow);
    }

    .info-card h3 {
        color: var(--primary);
        margin-bottom: 1rem;
        font-size: 1.2rem;
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        padding: 0.8rem 0;
        border-bottom: 1px solid var(--light);
    }

    .info-item:last-child {
        border-bottom: none;
    }

    .info-label {
        font-weight: 600;
        color: var(--gray);
    }

    .info-value {
        color: var(--dark);
    }

    .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .tag {
        background: var(--light);
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.85rem;
        color: var(--dark);
    }

    .category-badge {
        background: var(--primary);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        display: inline-block;
        font-weight: 600;
    }

    .loading {
        text-align: center;
        padding: 3rem;
    }

    @media (max-width: 968px) {
        .detail-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="detail-container">
    <div class="loading" id="loading">Loading meme...</div>
    
    <div class="detail-grid" id="memeDetail" style="display: none;">
        <div class="meme-main">
            <div class="meme-image-container">
                <img id="memeImage" class="meme-image-large" alt="Meme">
            </div>
            
            <h1 id="memeTitle"></h1>
            <p id="memeDescription" style="color: var(--gray); margin-top: 1rem;"></p>
            
            <div class="meme-actions">
                <button class="action-btn btn-like" id="likeBtn">
                    <span>‚ù§Ô∏è</span>
                    <span id="likeText">Like</span>
                </button>
                <button class="action-btn btn-download" id="downloadBtn">
                    <span>‚¨áÔ∏è</span>
                    <span>Download</span>
                </button>
                <button class="action-btn btn-delete" id="deleteBtn" style="display: none;">
                    <span>üóëÔ∏è</span>
                    <span>Delete</span>
                </button>
            </div>
        </div>

        <div class="meme-sidebar">
            <div class="info-card">
                <h3>üìä Statistics</h3>
                <div class="info-item">
                    <span class="info-label">Likes</span>
                    <span class="info-value" id="likesCount">0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Views</span>
                    <span class="info-value" id="viewsCount">0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Downloads</span>
                    <span class="info-value" id="downloadsCount">0</span>
                </div>
            </div>

            <div class="info-card">
                <h3>‚ÑπÔ∏è Information</h3>
                <div class="info-item">
                    <span class="info-label">Category</span>
                    <span class="info-value"><span class="category-badge" id="categoryBadge"></span></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Uploader</span>
                    <span class="info-value" id="uploaderName"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Uploaded</span>
                    <span class="info-value" id="uploadDate"></span>
                </div>
            </div>

            <div class="info-card" id="tagsCard" style="display: none;">
                <h3>üè∑Ô∏è Tags</h3>
                <div class="tag-list" id="tagsList"></div>
            </div>

            <div class="info-card" id="detectedTextCard" style="display: none;">
                <h3>üìù Detected Text</h3>
                <p id="detectedText" style="color: var(--gray); font-size: 0.9rem;"></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const memeId = '{{ meme_id }}';
    let currentMeme = null;

    async function loadMeme() {
        try {
            const response = await fetch(`/api/meme/${memeId}`);
            const data = await response.json();

            if (data.success) {
                currentMeme = data.meme;
                displayMeme(currentMeme);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('memeDetail').style.display = 'grid';
            } else {
                document.getElementById('loading').textContent = 'Meme not found';
            }
        } catch (error) {
            document.getElementById('loading').textContent = 'Error loading meme';
            console.error('Error:', error);
        }
    }

    function displayMeme(meme) {
        document.getElementById('memeImage').src = meme.s3_url;
        document.getElementById('memeTitle').textContent = meme.title;
        document.getElementById('memeDescription').textContent = meme.description || 'No description provided';
        
        document.getElementById('likesCount').textContent = meme.likes;
        document.getElementById('viewsCount').textContent = meme.views;
        document.getElementById('downloadsCount').textContent = meme.downloads;
        
        document.getElementById('categoryBadge').textContent = meme.category;
        document.getElementById('uploaderName').textContent = meme.uploader_username;
        document.getElementById('uploadDate').textContent = new Date(meme.created_at).toLocaleDateString();

        // Tags
        if (meme.tags && meme.tags.length > 0) {
            const tagsList = document.getElementById('tagsList');
            tagsList.innerHTML = meme.tags.map(tag => `<span class="tag">${tag}</span>`).join('');
            document.getElementById('tagsCard').style.display = 'block';
        }

        // Detected text
        if (meme.detected_text) {
            document.getElementById('detectedText').textContent = meme.detected_text;
            document.getElementById('detectedTextCard').style.display = 'block';
        }

        // Show delete button if owner
        {% if session.user_id %}
        if (meme.uploader_id === '{{ session.user_id }}') {
            document.getElementById('deleteBtn').style.display = 'flex';
        }
        {% endif %}

        document.title = `${meme.title} - Meme Museum`;
    }

    // Like button
    document.getElementById('likeBtn').addEventListener('click', async () => {
        {% if not session.username %}
        window.location.href = '{{ url_for("login_page") }}';
        return;
        {% endif %}

        try {
            const response = await fetch(`/api/meme/${memeId}/like`, { method: 'POST' });
            if (response.ok) {
                const likesElement = document.getElementById('likesCount');
                likesElement.textContent = parseInt(likesElement.textContent) + 1;
                document.getElementById('likeText').textContent = 'Liked!';
            }
        } catch (error) {
            console.error('Error liking meme:', error);
        }
    });

    // Download button
    document.getElementById('downloadBtn').addEventListener('click', async () => {
        try {
            await fetch(`/api/meme/${memeId}/download`, { method: 'POST' });
            
            const link = document.createElement('a');
            link.href = currentMeme.s3_url;
            link.download = currentMeme.title;
            link.click();
            
            const downloadsElement = document.getElementById('downloadsCount');
            downloadsElement.textContent = parseInt(downloadsElement.textContent) + 1;
        } catch (error) {
            console.error('Error downloading meme:', error);
        }
    });

    // Delete button
    document.getElementById('deleteBtn').addEventListener('click', async () => {
        if (!confirm('Are you sure you want to delete this meme?')) return;

        try {
            const response = await fetch(`/api/meme/${memeId}/delete`, { method: 'DELETE' });
            if (response.ok) {
                alert('Meme deleted successfully!');
                window.location.href = '{{ url_for("dashboard") }}';
            }
        } catch (error) {
            console.error('Error deleting meme:', error);
            alert('Failed to delete meme');
        }
    });

    // Load meme on page load
    loadMeme();
</script>
{% endblock %}